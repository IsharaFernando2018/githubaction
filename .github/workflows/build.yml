name: CI/CD Microservices
##

on:
  push:
    branches:
      - main
    paths:
      - "*/**"         # catch all service dirs
      - "helm-charts/**"

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Log in to Docker Registry
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Detect Changed Services
        id: changes
        run: |
          CHANGED_DIRS=$(git diff --name-only HEAD~1 HEAD 2>/dev/null || git ls-tree --name-only -d HEAD)
          # Filter only Project-01 subdirectories
          CHANGED_DIRS=$(echo $CHANGED_DIRS | grep '^Project-01/' | cut -d/ -f2 | sort -u)
          # Convert to comma-separated list for safe output
          CHANGED_DIRS=$(echo $CHANGED_DIRS | tr ' ' ',')
          echo "Changed dirs: $CHANGED_DIRS"
          echo "changed=$CHANGED_DIRS" >> $GITHUB_OUTPUT

      - name: Build & Push Images
        run: |
          for svc in ${{ steps.changes.outputs.changed }}; do
            if [ -f "$svc/Dockerfile" ]; then
              IMAGE="${{ secrets.DOCKER_USERNAME }}/$svc:${GITHUB_SHA::7}"
              echo "ðŸš€ Building and pushing $IMAGE"
              docker build -t $IMAGE $svc
              docker push $IMAGE

              # Update Helm values.yaml if chart exists
              if [ -f "helm-charts/$svc/values.yaml" ]; then
                sed -i "s|repository:.*|repository: ${{ secrets.DOCKER_USERNAME }}/$svc|g" helm-charts/$svc/values.yaml
                sed -i "s|tag:.*|tag: ${GITHUB_SHA::7}|g" helm-charts/$svc/values.yaml
              fi
            fi
          done

      - name: Commit Helm Changes
        run: |
          git config --global user.email "actions@github.com"
          git config --global user.name "github-actions"
          git add helm-charts/
          git commit -m "Update image tags [skip ci]" || echo "No changes to commit"
          git push
